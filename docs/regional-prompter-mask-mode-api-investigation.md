# Regional Prompter Mask Mode API æ¤œè¨¼çµæœãƒ¬ãƒãƒ¼ãƒˆ

## èª¿æŸ»æ—¥æ™‚
2025å¹´9æœˆ19æ—¥ï¼ˆåˆå›èª¿æŸ»ï¼‰
2025å¹´9æœˆ19æ—¥ï¼ˆæœ€çµ‚æ›´æ–°ï¼‰

## æ¦‚è¦
SD WebUI Reforge ã® Regional Prompter æ‹¡å¼µæ©Ÿèƒ½ã«ãŠã‘ã‚‹ Mask ãƒ¢ãƒ¼ãƒ‰ãŒã€API çµŒç”±ã§æ­£å¸¸ã«å‹•ä½œã—ãªã„å•é¡Œã«ã¤ã„ã¦è©³ç´°ãªèª¿æŸ»ã‚’å®Ÿæ–½ã—ã¾ã—ãŸã€‚

## ä¸»è¦ãªç™ºè¦‹äº‹é …

### 1. æ ¹æœ¬åŸå› ï¼š`REGUSE` ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®æœªåˆæœŸåŒ–

#### GUI ã§ã®å‹•ä½œãƒ•ãƒ­ãƒ¼ï¼ˆæ­£å¸¸ï¼‰
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒã‚¹ã‚¯ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
2. `detect_image_colours()` é–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹
3. ãƒã‚¹ã‚¯ç”»åƒã®è‰²ã‚’æ¤œå‡ºã—ã€`REGUSE` ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ç™»éŒ²
4. `inpaintmaskdealer()` ã§ `REGUSE` ã‚’å‚ç…§ã—ã¦ãƒã‚¹ã‚¯å‡¦ç†ã‚’å®Ÿè¡Œ

#### API ã§ã®å‹•ä½œãƒ•ãƒ­ãƒ¼ï¼ˆå•é¡Œã‚ã‚Šï¼‰
1. Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒã‚¹ã‚¯ç”»åƒã‚’å—ä¿¡
2. `draw_image()` â†’ `detect_image_colours()` ã¨å‡¦ç†
3. **`REGUSE` ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ãŒé©åˆ‡ã«åˆæœŸåŒ–ã•ã‚Œãªã„**
4. `inpaintmaskdealer()` ã§ `REGUSE` ãŒç©ºã®ãŸã‚ã€ãƒã‚¹ã‚¯å‡¦ç†ãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹

### 2. ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ™ãƒ«ã®è©³ç´°åˆ†æ

#### å•é¡Œã®ã‚³ãƒ¼ãƒ‰ç®‡æ‰€ï¼ˆ`regions.py`ï¼‰

```python
# 765è¡Œç›®: inpaintmaskdealer é–¢æ•°
def inpaintmaskdealer(self, p, bratios, usebase, polymask):
    # ...
    # 777è¡Œç›®: REGUSE ãŒç©ºã ã¨ãƒ«ãƒ¼ãƒ—ãŒå®Ÿè¡Œã•ã‚Œãªã„
    for c in sorted(REGUSE.keys()):
        m = detect_mask(polymask, c, 1)
        # ãƒã‚¹ã‚¯å‡¦ç†
```

#### REGUSE ã®åˆæœŸåŒ–ï¼ˆ`regions.py`ï¼‰

```python
# 427è¡Œç›®: ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°å®šç¾©
REGUSE = dict()  # Used regions. Reset on new canvas / upload (preset).

# 584è¡Œç›®: detect_image_colours å†…ã§ã® REGUSE è¨­å®š
REGUSE = {reg[0,0]: reg[0,1:].tolist() for reg in regrows if len(reg) > 0 and reg[0,0] <= MAX_KEY_VALUE}
```

### 3. ãªãœæ™‚ã€…å‹•ä½œã™ã‚‹ã®ã‹

**GUI ã§ã®è¨­å®šãŒæ®‹å­˜ã™ã‚‹ç¾è±¡**ï¼š
- GUI ã§ä¸€åº¦ Mask ãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€`REGUSE` ã«è‰²æƒ…å ±ãŒä¿å­˜ã•ã‚Œã‚‹
- ãã®å¾Œ API ã‚’å‘¼ã³å‡ºã™ã¨ã€å‰å›ã® GUI è¨­å®šã® `REGUSE` ãŒä½¿ã‚ã‚Œã¦å‹•ä½œã™ã‚‹å ´åˆãŒã‚ã‚‹
- ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•ã™ã‚‹ã¨ `REGUSE` ãŒã‚¯ãƒªã‚¢ã•ã‚Œã€å†ã³å‹•ä½œã—ãªããªã‚‹

## æŠ€è¡“çš„è©³ç´°

### ãƒã‚¹ã‚¯è‰²ã®ç”Ÿæˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

Regional Prompter ã¯æ±ºå®šè«–çš„ãª HSV è‰²ç”Ÿæˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ä½¿ç”¨ï¼š

```python
def generateRegionColor(index):
    # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ 0: H=0
    # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ 1: H=0.5
    # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ 2ä»¥é™: ãƒã‚¤ãƒŠãƒªãƒ„ãƒªãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³
    # S=0.5, V=0.5 å›ºå®š
```

å®Ÿéš›ã®è‰²ãƒãƒƒãƒ”ãƒ³ã‚°ä¾‹ï¼š
- Region 1 (index=1): RGB(64, 128, 128) - é’ç·‘è‰²
- Region 2 (index=2): RGB(96, 128, 64) - é»„ç·‘è‰²

### API ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ§‹é€ 

Regional Prompter ã¯ 16 å¼•æ•° + ãƒã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ï¼ˆ17ç•ªç›®ï¼‰ã®æ§‹é€ ï¼š

```javascript
const rpArgs = [
    active,           // 1: æœ‰åŠ¹/ç„¡åŠ¹
    debug,            // 2: ãƒ‡ãƒãƒƒã‚°
    mode,             // 3: "Mask"
    matrix_submode,   // 4: "Columns"
    mask_submode,     // 5: "Mask"
    prompt_submode,   // 6: "Prompt"
    divide_ratio,     // 7: "1,1"
    base_ratio,       // 8: "0.2,0.2,0.2" (BREAKæ•°ã«å¿œã˜ã¦èª¿æ•´)
    use_base,         // 9: true/false
    use_common,       // 10: true/false
    use_ncommon,      // 11: true/false
    calc_mode,        // 12: "Attention"
    not_change_and,   // 13: false
    lora_stop_step,   // 14: "0"
    lora_hires_stop,  // 15: "0"
    threshold,        // 16: "0.4"
    maskDataURI       // 17: "data:image/png;base64,..."
];
```

### bratios é…åˆ—ã®å•é¡Œ

Mask ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€`bratios` ãŒ BREAK æ•°ã«å¿œã˜ã¦å‹•çš„ã«èª¿æ•´ã•ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š

```javascript
// BREAKæ•° = 2 ã®å ´åˆ
// ãƒªãƒ¼ã‚¸ãƒ§ãƒ³æ•° = 3
// bratios = "0.2,0.2,0.2"
```

## è©¦è¡Œã—ãŸä¿®æ­£

### 1. MCP ã‚µãƒ¼ãƒãƒ¼å´ã§ã®å¯¾ç­–

å®Ÿè£…ã—ãŸä¿®æ­£å†…å®¹ï¼š
- è¤‡æ•°ã®ç™½é»’ãƒã‚¹ã‚¯ã‚’å˜ä¸€ã®ã‚«ãƒ©ãƒ¼ãƒã‚¹ã‚¯ã«åˆæˆ
- æ±ºå®šè«–çš„è‰²ç”Ÿæˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®å®Ÿè£…
- Base64 ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§ã®ãƒã‚¹ã‚¯é€ä¿¡
- bratios é…åˆ—ã®å‹•çš„èª¿æ•´
- ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ 1 ã‹ã‚‰é–‹å§‹

### 2. ã‚¨ãƒ©ãƒ¼å‡¦ç†ã®æ”¹å–„

```javascript
// bratios æ°¸ç¶šåŒ–å•é¡Œã®ä¿®æ­£
if (!baseRatioValue || baseRatioValue === '' || baseRatioValue === '[]') {
    baseRatioValue = '0.2';
}
```

## ğŸš¨ é‡è¦ãªæ—¢çŸ¥ã®å•é¡Œ - GitHub Issue #408

### å•é¡Œã®æ¦‚è¦
[GitHub Issue #408](https://github.com/hako-mikan/sd-webui-regional-prompter/issues/408) ã«ã‚ˆã‚Šã€Regional Prompter ã®ä¸€éƒ¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ Matrix/Mask ãƒ¢ãƒ¼ãƒ‰ãŒæ­£å¸¸ã«å‹•ä½œã—ãªã„å•é¡ŒãŒå ±å‘Šã•ã‚Œã¦ã„ã¾ã™ã€‚

### å½±éŸ¿ã‚’å—ã‘ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³
- **å•é¡Œã®ã‚ã‚‹ã‚³ãƒŸãƒƒãƒˆ**: ç‰¹å®šã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆ2024å¹´å¾ŒåŠä»¥é™ã®ä¸€éƒ¨ï¼‰
- **æ¨å¥¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: Issue #408 ä»¥å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¸ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¨å¥¨
- **ç¢ºèªæ—¥**: 2025å¹´9æœˆ19æ—¥

### ç—‡çŠ¶
- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§æŒ‡å®šã—ãŸé ˜åŸŸåˆ†å‰²ãŒæ­£ã—ãåæ˜ ã•ã‚Œãªã„
- è‰²æŒ‡å®šãŒæ„å›³ã—ãªã„é ˜åŸŸã«é©ç”¨ã•ã‚Œã‚‹
- ç‰¹ã«ControlNetã¨ä½µç”¨æ™‚ã«é¡•è‘—

### å¯¾å‡¦æ³•
**ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯**: ä»¥å‰ã®å®‰å®šãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æˆ»ã™
```bash
cd sd-webui-regional-prompter
git checkout [ä»¥å‰ã®å®‰å®šç‰ˆã‚³ãƒŸãƒƒãƒˆ]
```

## â­ 2025å¹´9æœˆ19æ—¥æ›´æ–°: Mask ãƒ¢ãƒ¼ãƒ‰ API å¯¾å¿œæˆåŠŸ

### è§£æ±ºæ–¹æ³•

MCP ã‚µãƒ¼ãƒãƒ¼å´ã§è¤‡æ•°ã®ç™½é»’ãƒã‚¹ã‚¯ã‚’ Regional Prompter ã®æœŸå¾…ã™ã‚‹å½¢å¼ï¼ˆã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰åŒ–ã•ã‚ŒãŸå˜ä¸€ãƒã‚¹ã‚¯ï¼‰ã«å¤‰æ›ã™ã‚‹ã“ã¨ã§ã€API çµŒç”±ã§ã® Mask ãƒ¢ãƒ¼ãƒ‰ä½¿ç”¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚

#### å®Ÿè£…ã—ãŸè§£æ±ºç­–

1. **`deterministic_colours` ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®å®Œå…¨å†ç¾**
   - Regional Prompter ã®è‰²ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Œå…¨ã«å†ç¾
   - ãƒã‚¤ãƒŠãƒªãƒ„ãƒªãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚ˆã‚‹ Hue å€¤è¨ˆç®—
   - HSV(H=è¨ˆç®—å€¤, S=0.5, V=0.5) â†’ RGB å¤‰æ›

2. **Jimp v1.6.0 ã«ã‚ˆã‚‹ç”»åƒåˆæˆ**
   ```javascript
   const { Jimp } = require('jimp');
   const { intToRGBA, rgbaToInt } = require('@jimp/utils');
   ```

3. **17ç•ªç›®ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦é€ä¿¡**
   - Base64 ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸåˆæˆãƒã‚¹ã‚¯ã‚’ polymask ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦é€ä¿¡

### ç¾åœ¨ã®åˆ¶é™äº‹é …ï¼ˆè§£æ±ºæ¸ˆã¿ï¼‰

~~API çµŒç”±ã§ã® Mask ãƒ¢ãƒ¼ãƒ‰ä½¿ç”¨ä¸å¯~~ â†’ **âœ… è§£æ±ºæ¸ˆã¿ï¼ˆ2025å¹´9æœˆ19æ—¥ï¼‰**

## ä»Šå¾Œã®æ”¹å–„ææ¡ˆ

### Regional Prompter ã¸ã®æ”¹ä¿®æ¡ˆ

1. **API ãƒ¢ãƒ¼ãƒ‰æ¤œå‡ºã®è¿½åŠ **
   ```python
   def process(self, p, ...):
       if is_api_call():
           self.initialize_reguse_from_mask(polymask)
   ```

2. **REGUSE ã®æ˜ç¤ºçš„åˆæœŸåŒ–**
   ```python
   def initialize_reguse_from_mask(self, polymask):
       if polymask:
           img = Image.open(BytesIO(base64.b64decode(polymask)))
           detect_image_colours(np.array(img.convert('RGB')))
   ```

3. **API ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ‹¡å¼µ**
   - è‰²æƒ…å ±ã‚’ç›´æ¥æŒ‡å®šã§ãã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è¿½åŠ 
   - `reguse_colors` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§è‰²ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’å—ã‘å–ã‚‹

## çµè«–

### âœ… è§£æ±ºæ¸ˆã¿ï¼ˆ2025å¹´9æœˆ19æ—¥ï¼‰

Regional Prompter ã® Mask ãƒ¢ãƒ¼ãƒ‰ã¯ã€MCP ã‚µãƒ¼ãƒãƒ¼å´ã§ã®é©åˆ‡ãªå‰å‡¦ç†ã«ã‚ˆã‚Š **API çµŒç”±ã§ã‚‚å®Œå…¨ã«å‹•ä½œã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸ**ã€‚

#### æˆåŠŸã—ãŸå®Ÿè£…
- è¤‡æ•°ã®ç™½é»’ãƒã‚¹ã‚¯ã‚’å˜ä¸€ã®ã‚«ãƒ©ãƒ¼ãƒã‚¹ã‚¯ã«åˆæˆ
- Regional Prompter ã® `deterministic_colours` ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’å®Œå…¨å†ç¾
- Base64 ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã§ã® polymask ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿é€ä¿¡

#### ä½¿ç”¨å¯èƒ½ãªãƒ¢ãƒ¼ãƒ‰
- **Matrix ãƒ¢ãƒ¼ãƒ‰** âœ… ï¼ˆã‚°ãƒªãƒƒãƒ‰åˆ†å‰²ï¼‰
- **Mask ãƒ¢ãƒ¼ãƒ‰** âœ… ï¼ˆãƒã‚¹ã‚¯ãƒ™ãƒ¼ã‚¹é ˜åŸŸåˆ¶å¾¡ï¼‰
- **Prompt ãƒ¢ãƒ¼ãƒ‰** âš ï¸ ï¼ˆAPI ã§ã®å‹•ä½œæœªæ¤œè¨¼ï¼‰

## å‚è€ƒè³‡æ–™

### é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«
- `/sd-webui-regional-prompter/scripts/rp.py` - ãƒ¡ã‚¤ãƒ³ã®å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯
- `/sd-webui-regional-prompter/scripts/regions.py` - ãƒã‚¹ã‚¯å‡¦ç†ã¨è‰²æ¤œå‡º
- `/sd-webui-regional-prompter/scripts/attention.py` - ã‚¢ãƒ†ãƒ³ã‚·ãƒ§ãƒ³å‡¦ç†

### ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã®å ´æ‰€
- `mcp-tool-execution.log` - MCP ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œãƒ­ã‚°
- `mcp-tool-calls.log` - API å‘¼ã³å‡ºã—ãƒ­ã‚°
- `temp_masks/` - ç”Ÿæˆã•ã‚ŒãŸãƒã‚¹ã‚¯ç”»åƒ

## èª¿æŸ»è€…ãƒ¡ãƒ¢

ã“ã®å•é¡Œã¯ Regional Prompter ã®è¨­è¨ˆæ€æƒ³ã«èµ·å› ã™ã‚‹ã‚‚ã®ã§ã‚ã‚Šã€å®Œå…¨ãªè§£æ±ºã«ã¯æ‹¡å¼µæ©Ÿèƒ½è‡ªä½“ã®æ”¹ä¿®ãŒå¿…è¦ã§ã™ã€‚ç¾æ™‚ç‚¹ã§ã¯ã€API ä½¿ç”¨æ™‚ã¯ Matrix ãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒæœ€ã‚‚ç¾å®Ÿçš„ãªè§£æ±ºç­–ã§ã™ã€‚

---

*æœ€çµ‚æ›´æ–°: 2025å¹´9æœˆ19æ—¥*
*èª¿æŸ»å®Ÿæ–½: Claude Code (claude-opus-4-1-20250805)*